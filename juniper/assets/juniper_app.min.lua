local B=0x0c;local T=0x09;local a=0x0a;local b=0x10;local c=0x12;local d={};local e={};local f={};local g=false;local h=0;function update_app_data_accum(i)local j=string.byte(i,1)local k=d[j]if k==nil or next(k)==nil then k={chunk_table={},num_chunks=0,size=0,recv_bytes=0}d[j]=k end;if k.num_chunks==0 then k.size=string.byte(i,2)<<8|string.byte(i,3)k.chunk_table[1]=string.sub(i,4)k.num_chunks=1;k.recv_bytes=string.len(i)-3;if k.recv_bytes==k.size then e[j]=k.chunk_table[1]k.size=0;k.recv_bytes=0;k.num_chunks=0;k.chunk_table[1]=nil;d[j]=k end else k.chunk_table[k.num_chunks+1]=string.sub(i,2)k.num_chunks=k.num_chunks+1;k.recv_bytes=k.recv_bytes+string.len(i)-1;if k.recv_bytes==k.size then e[j]=table.concat(k.chunk_table)for l,m in pairs(k.chunk_table)do k.chunk_table[l]=nil end;k.size=0;k.recv_bytes=0;k.num_chunks=0;d[j]=k end end end;function n(i)local o={}o.data=i;return o end;function p(i)local q={}q.value=string.byte(i,1)return q end;function r(i)local s={}s.value=string.byte(i,1)return s end;function handle_tap()pcall(frame.bluetooth.send,string.char(T))end;local t={}t[a]=n;t[b]=p;t[c]=r;function process_raw_items()local u=0;for j,v in pairs(e)do f[j]=t[j](v)e[j]=nil;u=u+1 end;return u end;function print_text()local w=0;for x in f[a].data:gmatch("([^\n]*)\n?")do if x~=""then frame.display.text(x,1,w*60+1)w=w+1 end end;frame.display.show()g=true;h=frame.time.utc()+15 end;function clear_display()frame.display.text(" ",1,1)frame.display.show()g=false;h=0 end;function app_loop()clear_display()local y=0;local z=0;while true do rc,err=pcall(function()local u=process_raw_items()if u>0 then if f[a]~=nil and f[a].data~=nil then print_text()f[a]=nil end;if f[b]~=nil then if f[b].value==1 then frame.imu.tap_callback(handle_tap)else frame.imu.tap_callback(nil)end;f[b]=nil end;if f[c]~=nil then clear_display()f[c]=nil end end;z=frame.time.utc()if g and h>0 and z>h then clear_display()end;local A=frame.time.utc()if y==0 or A-y>120 then pcall(frame.bluetooth.send,string.char(B)..string.char(math.floor(frame.battery_level())))y=A end;frame.sleep(0.1)end)if rc==false then print(err)clear_display()break end end end;frame.bluetooth.receive_callback(update_app_data_accum)app_loop()
