BATTERY_LEVEL_FLAG=0x0c;TEXT_FLAG=0x0a;POSITIONED_TEXT_FLAG=0x0b;CODE_FLAG=0x10;CLEAR_FLAG=0x12;local a={}local b={}local c={}function update_app_data_accum(d)local e=string.byte(d,1)local f=a[e]if f==nil or next(f)==nil then f={chunk_table={},num_chunks=0,size=0,recv_bytes=0}a[e]=f end;if f.num_chunks==0 then f.size=string.byte(d,2)<<8|string.byte(d,3)f.chunk_table[1]=string.sub(d,4)f.num_chunks=1;f.recv_bytes=string.len(d)-3;if f.recv_bytes==f.size then b[e]=f.chunk_table[1]f.size=0;f.recv_bytes=0;f.num_chunks=0;f.chunk_table[1]=nil;a[e]=f end else f.chunk_table[f.num_chunks+1]=string.sub(d,2)f.num_chunks=f.num_chunks+1;f.recv_bytes=f.recv_bytes+string.len(d)-1;if f.recv_bytes==f.size then b[e]=table.concat(f.chunk_table)for g,h in pairs(f.chunk_table)do f.chunk_table[g]=nil end;f.size=0;f.recv_bytes=0;f.num_chunks=0;a[e]=f end end end;function parse_text(d)return{data=d}end;function parse_positioned_text(d)local i={}local j=string.find(d," ")if j then local k=string.sub(d,1,j-1)local l=string.sub(d,j+1)local m=string.find(k,",")if m then i.x=tonumber(string.sub(k,1,m-1))or 1;i.y=tonumber(string.sub(k,m+1))or 1;i.text=l else i.x=1;i.y=1;i.text=d end else i.x=1;i.y=1;i.text=d end;return i end;function parse_code(d)return{command=string.len(d)>0 and string.byte(d,1)or 0}end;function parse_clear(d)return{command="clear"}end;local n={}n[TEXT_FLAG]=parse_text;n[POSITIONED_TEXT_FLAG]=parse_positioned_text;n[CODE_FLAG]=parse_code;n[CLEAR_FLAG]=parse_clear;function process_raw_items()local o=0;for p,q in pairs(b)do c[p]=n[p](q)b[p]=nil;o=o+1 end;return o end;function print_text()local r=0;for s in c[TEXT_FLAG].data:gmatch("([^\n]*)\n?")do if s~=""then frame.display.text(s,1,r*60+1)r=r+1 end end end;function app_loop()local t=0;while true do rc,err=pcall(function()local u=process_raw_items()frame.sleep(0.005)if u>0 then if c[TEXT_FLAG] then frame.display.text(" ",1,1)print_text()frame.display.show()c[TEXT_FLAG]=nil end;if c[POSITIONED_TEXT_FLAG] then local v=c[POSITIONED_TEXT_FLAG]frame.display.text(v.text,v.x,v.y)c[POSITIONED_TEXT_FLAG]=nil end;if c[CODE_FLAG] then if c[CODE_FLAG].command==1 then frame.display.show()end;c[CODE_FLAG]=nil end;if c[CLEAR_FLAG] then frame.display.text(" ",1,1)frame.display.show()c[CLEAR_FLAG]=nil end end;frame.sleep(0.005)local w=frame.time.utc()if t==0 or w-t>180 then pcall(frame.bluetooth.send,string.char(BATTERY_LEVEL_FLAG)..string.char(math.floor(frame.battery_level())))t=w end end)if rc==false then print(err)frame.display.text(" ",1,1)frame.display.show()frame.sleep(0.04)break end end end;frame.bluetooth.receive_callback(update_app_data_accum)app_loop()
